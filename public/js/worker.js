function Mash(){let t=4022871197;let e=e=>{e=e.toString();for(let a=0,i=e.length;a<i;a++){t+=e.charCodeAt(a);let i=.02519603282416938*t;t=i>>>0;i-=t;i*=t;t=i>>>0;i-=t;t+=i*4294967296}return(t>>>0)*2.3283064365386963e-10};e.version="Mash 0.9";return e}function Alea(){return function(t){let e=0,a=0,i=0,r=1;if(t.length==0){t=[+new Date]}let l=Mash();e=l(" ");a=l(" ");i=l(" ");for(let r=0,n=t.length;r<n;r++){e-=l(t[r]);if(e<0){e+=1}a-=l(t[r]);if(a<0){a+=1}i-=l(t[r]);if(i<0){i+=1}}l=null;let n=function(){let t=2091639*e+r*2.3283064365386963e-10;e=a;a=i;return i=t-(r=t|0)};n.uint32=function(){return n()*4294967296};n.fract53=function(){return n()+(n()*2097152|0)*11102230246251565e-32};n.version="Alea 0.9";n.args=t;n.exportState=function(){return[e,a,i,r]};n.importState=function(t){e=+t[0]||0;a=+t[1]||0;i=+t[2]||0;r=+t[3]||0};return n}(Array.prototype.slice.call(arguments))}Alea.importState=function(t){let e=new Alea;e.importState(t);return e};class SimplexNoise{constructor(t){this.F2=.5*(Math.sqrt(3)-1);this.G2=(3-Math.sqrt(3))/6;let e=Math.random;if(typeof t=="function"){e=t}else if(t){e=new Alea(t).random}this.p=new Uint8Array(256);this.perm=new Uint8Array(512);this.permMod12=new Uint8Array(512);for(let t=0;t<256;t++){this.p[t]=e()*256}for(let t=0;t<512;t++){this.perm[t]=this.p[t&255];this.permMod12[t]=this.perm[t]%12}this.grad3=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]);this.grad4=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0])}noise2D(t,e){let a=this.permMod12,i=this.perm,r=this.grad3,l=0,n=0,o=0;let h=(t+e)*this.F2,s=Math.floor(t+h),f=Math.floor(e+h),d=(s+f)*this.G2,m=s-d,u=f-d,c=t-m,p=e-u,g,M;if(c>p){g=1;M=0}else{g=0;M=1}let w=c-g+this.G2,y=p-M+this.G2,b=c-1+2*this.G2,x=p-1+2*this.G2,L=s&255,A=f&255,D=.5-c*c-p*p;if(D>=0){let t=a[L+i[A]]*3;D*=D;l=D*D*(r[t]*c+r[t+1]*p)}let G=.5-w*w-y*y;if(G>=0){let t=a[L+g+i[A+M]]*3;G*=G;n=G*G*(r[t]*w+r[t+1]*y)}let k=.5-b*b-x*x;if(k>=0){let t=a[L+1+i[A+1]]*3;k*=k;o=k*k*(r[t]*b+r[t+1]*x)}return 70*(l+n+o)}}function colorTemperatureToRGB(t){t*=.01;let e,a,i;if(t<=66){e=255;a=99.4708025861*Math.log(t)-161.1195681661;if(t<=19){i=0}else{i=138.5177312231*Math.log(t-10)-305.0447927307}}else{e=329.698727446*Math.pow(t-60,-.1332047592);a=288.1221695283*Math.pow(t-60,-.0755148492);i=255}return[clamp(e,0,255),clamp(a,0,255),clamp(i,0,255)]}function clamp(t,e,a){return Math.min(Math.max(t,e),a)}function addVignette(t,e,a,i,r,l){let n=t.data,o=e.data,h=e.width,s=e.height,f=a.x,d=a.y,m=a.height,u=a.width,c=Math.min(a.width,a.height);for(let t=0;t<s;t++){let e=(t+d-m/2)/c;e*=e;for(let a=0;a<h;a++){let s=(t*h+a)*4,d=(a+f-u/2)/c;d*=d;let m=Math.sqrt(d+e);let p=1-Math.min(1,Math.max(0,(m-i)/r))*(1-1/l);n[s]=dither(o[s]*p);n[s+1]=dither(o[s+1]*p);n[s+2]=dither(o[s+2]*p)}}}function dither(t){let e=Math.floor(t),a=t-e;return Math.random()>a?e:Math.ceil(t)}function addGrain(t,e,a,i,r){let l=new SimplexNoise(new Alea);let n=t.data,o=e.data,h=e.width,s=e.height,f=a.x,d=a.y,m=Math.min(a.width,a.height);for(let t=0;t<s;t++){for(let e=0;e<h;e++){let a=(t*h+e)*4,s=(o[a]+o[a+1]+o[a+2])/768-.5,u=e+f,c=t+d,p=(l.noise2D(u/m*i,c/m*i)+l.noise2D(u/m*i/2,c/m*i/2)*.25+l.noise2D(u/m*i/4,c/m*i/4))*.5;p*=1-s*s*2;p*=r*255;n[a]=o[a]+p;n[a+1]=o[a+1]+p;n[a+2]=o[a+2]+p}}}function addLightLeak(t,e,a,i,r,l){let n=new SimplexNoise(new Alea(l));let o=t.data,h=e.data,s=e.width,f=e.height,d=a.x,m=a.y,u=Math.min(a.width,a.height);for(let t=0;t<f;t++){for(let e=0;e<s;e++){let a=(t*s+e)*4,l=e+d,f=t+m,c=(n.noise2D(l/u*r,f/u*r)+n.noise2D(l/u*r/2,f/u*r/2)*.25+n.noise2D(l/u*r/4,f/u*r/4))*.5,p=n.noise2D(l/u*r,f/u*r+1e3)*.5+1,g=n.noise2D(l/u*r+1e3,f/u*r)*.5+1,M=n.noise2D(l/u*r+1e3,f/u*r+1e3)*.5+1;c*=c;c*=i*255;o[a]=h[a]+c*p;o[a+1]=h[a+1]+c*g;o[a+2]=h[a+2]+c*M}}}function adjustTemperature(t,e,a){let i=t.data,r=e.data,[l,n,o]=colorTemperatureToRGB(a),h=.2126,s=.7152,f=.0722,d=l*h+n*s+o*f;l=d/l;n=d/n;o=d/o;for(let t=0;t<i.length;t+=4){r[t]=i[t]*l;r[t+1]=i[t+1]*n;r[t+2]=i[t+2]*o}}function adjust(t,e,a,i,r,l,n){let o=t.data,h=e.data,s=.2126,f=.7152,d=.0722;a=a/(1-n);for(let t=0;t<o.length;t+=4){let e=h[t]/255,m=h[t+1]/255,u=h[t+2]/255,c=(e*s+m*f+u*d)/(s+f+d);e=Math.max(0,e-n);m=Math.max(0,m-n);u=Math.max(0,u-n);let p=Math.max(e,m,u);let g=Math.min(e,m,u);let M=(p+g)/2;let w=M<.5?(p-g)/(1e-5+p+g):(p-g)/(1e-5+Math.max(0,2-p-g));let y=.8;let b=clamp((1-1.5*w+(1+Math.abs(M-.5)*2)*(1-y))/(1+(1-y)),0,1);let x=r+l*b;e+=(e-c)*x;m+=(m-c)*x;u+=(u-c)*x;e+=(e-.5)*i;m+=(m-.5)*i;u+=(u-.5)*i;e*=a;m*=a;u*=a;o[t]=dither(e*255);o[t+1]=dither(m*255);o[t+2]=dither(u*255)}}function mapColorsFast(t,e,a,i){let r=t.data,l=e.data,n=t.width,o=t.height,h=a.data,s=Math.floor(Math.pow(a.width,1/3)+.001),f=s*s,d=f-1;let m=1-i,u=i;for(let t=0;t<o;t++){for(let e=0;e<n;e++){let a=(t*n+e)*4,i=l[a]/255*d,o=l[a+1]/255*d,s=l[a+2]/255*d,c=l[a+3]/255,p=(dither(s)*f*f+dither(o)*f+dither(i))*4;r[a]=l[a]*m+u*h[p];r[a+1]=l[a+1]*m+u*h[p+1];r[a+2]=l[a+2]*m+u*h[p+2];r[a+3]=c*255}}}function noisy(t){return Math.min(Math.max(0,t+Math.random()-.5),255)}function mapColors(t,e,a,i){let r=t.data,l=e.data,n=t.width,o=t.height,h=a.data,s=Math.floor(Math.pow(a.width,1/3)+.001),f=s*s,d=f-1;let m=[0,0,0],u=[0,0,0],c=[0,0,0],p=[0,0,0],g=[0,0,0],M=[0,0,0],w=[0,0,0],y=[0,0,0];for(let t=0;t<o;t++){for(let e=0;e<n;e++){let a=(t*n+e)*4,o=l[a]/256*d,s=l[a+1]/256*d,b=l[a+2]/256*d,x=l[a+3]/256,L=Math.floor(o),A=Math.ceil(o),D=Math.floor(s),G=Math.ceil(s),k=Math.floor(b),v=Math.ceil(b);sample(m,h,f,L,D,k);sample(u,h,f,L,D,v);sample(c,h,f,L,G,k);sample(p,h,f,L,G,v);sample(g,h,f,A,D,k);sample(M,h,f,A,D,v);sample(w,h,f,A,G,k);sample(y,h,f,A,G,v);let S=b-k;rgbLerp(m,m,u,S);rgbLerp(c,c,p,S);rgbLerp(g,g,M,S);rgbLerp(w,w,y,S);S=s-D;rgbLerp(m,m,c,S);rgbLerp(g,g,w,S);S=o-L;rgbLerp(m,m,g,S);let C=1-i,F=i;r[a]=l[a]*C+m[0]*F;r[a+1]=r[a+1]*C+m[1]*F;r[a+2]=r[a+2]*C+m[2]*F;r[a+3]=x*256}}}function rgbLerp(t,e,a,i){t[0]=e[0]+(a[0]-e[0])*i;t[1]=e[1]+(a[1]-e[1])*i;t[2]=e[2]+(a[2]-e[2])*i}function sample(t,e,a,i,r,l){let n=(l*a*a+r*a+i)*4;t[0]=e[n];t[1]=e[n+1];t[2]=e[n+2]}function processImage(t,e,a){if(a.brightness&&a.brightness!==1||a.contrast||a.saturation||a.vibrance||a.temperature||a.blacks){adjust(t,t,a.brightness||1,a.contrast||0,a.saturation||0,a.vibrance||0,a.blacks||0)}if(a.temperature&&a.temperature!=6500){adjustTemperature(t,t,a.temperature)}if(a.vignette&&a.vignette.intensity>0){addVignette(t,t,e,a.vignette.radius,a.vignette.falloff,a.vignette.intensity)}if(a.grain&&a.grain.intensity>0){addGrain(t,t,e,a.grain.scale,a.grain.intensity)}if(a.clut){if(a.highQuality){mapColors(t,t,a.clut,a.clutMix)}else{mapColorsFast(t,t,a.clut,a.clutMix)}}if(a.lightLeak&&a.lightLeak.seed>0){addLightLeak(t,t,e,a.lightLeak.intensity||1,a.lightLeak.scale,a.lightLeak.seed)}}let clut;let commands={setClut:t=>{clut=t},processImage:(t,e,a)=>{processImage(t,e,a);self.postMessage(t,[t.data.buffer])}};self.onmessage=function(t){commands[t.data.command].apply(self,t.data.arguments)};